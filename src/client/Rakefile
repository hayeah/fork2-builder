
require "json"
require "active_support"

desc "build javascript"
task :js => [
  "build/app-vendor.js",
  "build/app.js",
  "build/mobile.js",
  # "build/mobile-vendor.js",

]

file "build/app-vendor.js" => ["app-vendor.json"] do |t|
  puts "#{t.name} => #{t.source}"
  vendor_libs = JSON.parse(File.read("app-vendor.json"))
  requires = vendor_libs.to_a.map { |dep| "-r ./#{dep[1]}:#{dep[0]}" }.join " "
  cmd = "browserify --no-detect-globals #{requires} -o #{t.name} "
  puts cmd
  sh cmd
end

file "build/app.js" => ["app.coffee","app-vendor.coffee"] do |t|
  vendor_libs = JSON.parse(File.read("app-vendor.json"))
  externals = vendor_libs.to_a.map { |dep| "-x ./#{dep[1]}:#{dep[0]}" }.join " "
  cmd = "browserify  -t coffeeify --extension='.coffee' --no-detect-globals #{externals} app.coffee -o #{t.name} "
  # puts cmd
  sh cmd
end

file "build/mobile.js" => ["mobile.coffee","mobile-vendor.coffee"] do |t|
  vendor_libs = JSON.parse(File.read("mobile-vendor.json"))
  requires = vendor_libs.to_a.map { |dep| "-r ./#{dep[1]}:#{dep[0]}" }.join " "
  cmd = "browserify  -t coffeeify --extension='.coffee' --no-detect-globals #{requires} mobile.coffee -o #{t.name} "
  # puts cmd
  sh cmd
end
